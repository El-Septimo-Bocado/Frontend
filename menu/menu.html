<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Menú - El Séptimo Bocado</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="menu.css">
</head>
<body>
  <header class="navbar">
    <a href="../principal/index.html" class="logo"><img src="../iconos/logo.png" alt="logo" style="height:70px"></a>
    <nav>
      <ul>
        <li><a href="../principal/index.html">Inicio</a></li>
        <li><a href="../cartelera/cartelera.html">Cartelera</a></li>
        <li><a href="../menu/menu.html">Menu</a></li>
        <li><a href="../eventos/eventos.html">Eventos</a></li>
        <li><a href="../contacto/contacto.html">Contacto</a></li>
      </ul>
    </nav>
  </header>

  <h1>Menú</h1>

  <!-- BARRA: búsqueda / filtros -->
  <div class="toolbar">
    <input id="f_nombre" placeholder="Nombre (parcial)" type="text" />
    <select id="f_categoria">
      <option value="">Todas las categorías</option>
      <option value="BEBIDA">BEBIDA</option>
      <option value="SNACK">SNACK</option>
      <option value="COMBO">COMBO</option>
    </select>
    <select id="f_activo">
      <option value="">Todos</option>
      <option value="true">Activos</option>
      <option value="false">Inactivos</option>
    </select>
    <input id="f_precioMin" type="number" placeholder="Precio min" />
    <input id="f_precioMax" type="number" placeholder="Precio max" />
    <button id="btnBuscar">Buscar</button>
    <button id="btnRefrescar">Refrescar</button>
  </div>

  <!-- FORM: Crear producto (todos obligatorios) -->
  <h2>Crear Producto</h2>
  <form id="crearForm">
    <input id="nombre" type="text" placeholder="Nombre" required />
    <input id="descripcion" type="text" placeholder="Descripción" required />
    <select id="categoria" required>
      <option value="">Selecciona categoría</option>
      <option value="BEBIDA">BEBIDA</option>
      <option value="SNACK">SNACK</option>
      <option value="COMBO">COMBO</option>
    </select>
    <input id="precio" type="number" placeholder="Precio" required />
    <input id="stock" type="number" placeholder="Stock" required />
    <label><input id="activo" type="checkbox" checked /> Activo</label>
    <input id="imageUrl" type="text" placeholder="URL de imagen (Google Drive: use uc?export=view&id=ID)" required />
    <div>
      <button type="submit">Crear</button>
      <button type="button" id="limpiarForm">Limpiar</button>
    </div>
    <div id="formMsg" style="color:red;display:none"></div>
  </form>

  <!-- Tabla de productos -->
  <h2>Productos</h2>
  <table id="menuTable">
    <thead>
      <tr><th>ID</th><th>Imagen</th><th>Nombre</th><th>Descripción</th><th>Categoría</th><th>Precio</th><th>Stock</th><th>Activo</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="./menu.js"></script>
  <script>
    // UI wiring (usa las funciones del service en menu.js)
    async function cargarUI() {
      try {
        const productos = await getMenuProductos();
        renderProductos(productos);
      } catch (e) {
        console.error(e);
        alert("No se pudo cargar productos.");
      }
    }

    function renderProductos(productos) {
      const tbody = document.querySelector("#menuTable tbody");
      tbody.innerHTML = "";
      productos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id ?? ""}</td>
          <td><img class="card-img" src="${p.imageUrl ?? ''}" alt="${p.nombre ?? ''}" onerror="this.src='../menu/comida/placeholder.png'"/></td>
          <td>${p.nombre ?? ""}</td>
          <td>${p.descripcion ?? ""}</td>
          <td>${p.categoria ?? ""}</td>
          <td>${p.precio ?? ""}</td>
          <td>${p.stock ?? ""}</td>
          <td>${p.activo === true ? 'Sí' : 'No'}</td>
          <td class="actions">
            <button onclick="onEditar('${p.id}')">Editar</button>
            <button onclick="onEliminar('${p.id}')">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.onEditar = function(id) {
      window.location.href = `edit_menu.html?id=${encodeURIComponent(id)}`;
    };

    window.onEliminar = async function(id) {
      if (!confirm("¿Eliminar producto?")) return;
      try {
        await deleteProducto(id);
        await cargarUI();
      } catch (e) {
        console.error(e);
        alert("Error eliminando producto");
      }
    };

    document.getElementById("btnRefrescar").addEventListener("click", cargarUI);

    document.getElementById("btnBuscar").addEventListener("click", async () => {
      try {
        const nombre = document.getElementById("f_nombre").value.trim();
        const categoria = document.getElementById("f_categoria").value;
        const activo = document.getElementById("f_activo").value;
        const precioMin = document.getElementById("f_precioMin").value;
        const precioMax = document.getElementById("f_precioMax").value;
        const productos = await buscarMenuProductos({ nombre, categoria, activo, precioMin: precioMin || undefined, precioMax: precioMax || undefined });
        renderProductos(productos);
      } catch (e) {
        console.error(e);
        alert("Error al buscar productos");
      }
    });

    // Crear producto
    document.getElementById("crearForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const msgEl = document.getElementById("formMsg");
      msgEl.style.display = "none";
      const nombre = document.getElementById("nombre").value.trim();
      const descripcion = document.getElementById("descripcion").value.trim();
      const categoria = document.getElementById("categoria").value;
      const precio = Number(document.getElementById("precio").value);
      const stock = Number(document.getElementById("stock").value);
      const activo = document.getElementById("activo").checked;
      const imageUrl = document.getElementById("imageUrl").value.trim();

      if (!nombre || !descripcion || !categoria || isNaN(precio) || isNaN(stock) || !imageUrl) {
        msgEl.innerText = "Completa todos los campos obligatorios.";
        msgEl.style.display = "block";
        return;
      }

      try {
        await createProducto({ nombre, descripcion, categoria, precio, stock, activo, imageUrl });
        document.getElementById("crearForm").reset();
        await cargarUI();
      } catch (e) {
        console.error(e);
        msgEl.innerText = "Error creando producto";
        msgEl.style.display = "block";
      }
    });

    document.getElementById("limpiarForm").addEventListener("click", () => {
      document.getElementById("crearForm").reset();
      document.getElementById("formMsg").style.display = "none";
    });

    // carga inicial
    window.addEventListener("load", cargarUI);
  </script>
</body>
</html>
