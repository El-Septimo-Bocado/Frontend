<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cartelera</title>
  <link rel="stylesheet" href="cartelera.css"/>
</head>
<body>

<header class="navbar">
  <a href="../principal/index.html" class="logo">
    <img src="../iconos/logo.png" alt="El Séptimo Bocado">
  </a>
  <nav>
    <ul>
      <li><a href="../principal/index.html">Inicio</a></li>
      <li><a href="../cartelera/cartelera.html">Cartelera</a></li>
      <li><a href="../menu/menu.html">Menu</a></li>
      <li><a href="../eventos/eventos.html">Eventos</a></li>
      <li><a href="../login/login.html">Inicia Sesion</a></li>
      <li><a href="../contacto/contacto.html">Contacto</a></li>
    </ul>
  </nav>
</header>

<section class="cartelera">
  <h2 class="cartelera-titulo">En cartelera y próximamente</h2>
  <div id="cartelera-grid" class="cartelera-grid"></div>
</section>

<footer>
  <p>&copy; 2025 El Séptimo Bocado. Todos los derechos reservados.</p>
</footer>

<script>
  (function () {
    const API = "http://localhost:8080/api/movies";

    const mapMovie = (m) => ({
      id: m.id,
      titulo: m.titulo || m.title || "Película",
      imagen: m.coverArt || m.poster || "",
      poster: m.poster || "",
      fondo: m.fondo || "",
      director: m.director || "",
      generos: m.generos || "",
      duracion: m.duracion || "",
      rating: typeof m.rating === "number" ? m.rating : null,
      activo: m.activo !== false
    });

    function stars(r) {
      if (typeof r !== "number") return "—";
      const full = Math.floor(r);
      const half = (r - full) >= 0.5 ? 1 : 0;
      const empty = 5 - full - half;
      return "★".repeat(full) + (half ? "☆" : "") + "☆".repeat(empty);
    }

    function cardHTML(movie) {
      const etiqueta = movie.activo
        ? `<div class="etiqueta">Estreno</div>`
        : `<div class="etiquetaproximamente">Próximamente</div>`;

      const img = movie.imagen
        ? `<img src="${movie.imagen}" alt="${movie.titulo.replace(/"/g,'&quot;')}">`
        : `<div class="placeholder">Sin imagen</div>`;

      const pm = encodeURIComponent(JSON.stringify({
        titulo   : movie.titulo,
        poster   : movie.poster || movie.imagen,
        fondo    : movie.fondo,
        director : movie.director,
        generos  : movie.generos,
        duracion : movie.duracion
      }));

      return `
        <a href="../reservas/reservacion.html#pm=${pm}" class="tarjeta">
          ${etiqueta}
          ${img}
          <h2>${movie.titulo}</h2>
          <div class="rating">${stars(movie.rating)}</div>
        </a>
      `;
    }

    function render(list) {
      const grid = document.getElementById("cartelera-grid");
      if (!grid) return;
      if (!list.length) {
        grid.innerHTML = `<p class="msg-vacio">No hay películas para mostrar.</p>`;
        return;
      }
      grid.innerHTML = list.map(cardHTML).join("");
    }

    fetch(API)
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(data => {
        const movies = Array.isArray(data) ? data.map(mapMovie) : [];
        const ordenadas = [
          ...movies.filter(m => m.activo),
          ...movies.filter(m => !m.activo)
        ];
        render(ordenadas);
      })
      .catch(err => {
        console.error("[cartelera] error:", err);
        const grid = document.getElementById("cartelera-grid");
        if (grid) {
          grid.innerHTML = `
            <p class="error">No pude cargar la cartelera desde ${API}</p>
            <p class="error-sub">Verifica que el backend está corriendo y CORS habilitado.</p>
          `;
        }
      });
  })();
</script>

</body>
</html>
